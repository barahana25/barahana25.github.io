<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>위치-기반 AR.js 데모</title>

  <!-- A-Frame 1.3.0  ── AR.js 3.4 권장 버전 -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- AR.js location-only + A-Frame glue -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    body{margin:0;overflow:hidden;font-family:sans-serif}
  </style>
</head>

<body>
  <!-- ───────── 하단 GPS 상태 표시 바 ───────── -->
  <div id="gpsBar"
       style="position:fixed;bottom:0;left:0;width:100%;
              padding:6px 10px;background:rgba(0,0,0,.65);
              color:#fff;font-size:14px;font-family:monospace;
              z-index:9999;text-align:center">
    위도·경도 로딩 중…
  </div>

  <!-- ───────── AR Scene ───────── -->
  <a-scene
    vr-mode-ui="enabled:false"
    embedded
    renderer="antialias:true;alpha:true;logarithmicDepthBuffer:true"
    arjs="sourceType:webcam;videoTexture:true;debugUIEnabled:false">

    <!-- ★ new-location-based 카메라 -->
    <a-camera gps-new-camera rotation-reader></a-camera>

    <!-- ★ 목표 지점: 30 m 안이면 보이고, 카메라보다 2 m 위에 띄움 -->
    <a-box id="targetBox"
           gps-new-entity-place="latitude:36.35527; longitude:128.70246;"
           position="0 2 0"
           depth="2" height="5" width="5"
           material="color:#FF1493;opacity:0.9"
           look-at="[gps-new-camera]"
           visible="false"></a-box>
  </a-scene>

  <script>
    window.addEventListener('load', () => {
      const bar    = document.getElementById('gpsBar');
      const camera = document.querySelector('[gps-new-camera]');
      const box    = document.getElementById('targetBox');

      // 목표 좌표(수정해서 사용)
      const TARGET = { lat: 36.35527, lon: 128.70246 };

      // 거리 계산(Haversine)
      const toRad = d => d * Math.PI / 180;
      const distanceM = (p1, p2) => {
        const R = 6371000;
        const dLat = toRad(p2.lat - p1.lat);
        const dLon = toRad(p2.lon - p1.lon);
        const a =
          Math.sin(dLat/2)**2 +
          Math.cos(toRad(p1.lat)) * Math.cos(toRad(p2.lat)) *
          Math.sin(dLon/2)**2;
        return 2 * R * Math.asin(Math.sqrt(a));
      };

      /* 위치 갱신 이벤트 */
      camera.addEventListener('gps-camera-update-position', e => {
        const { latitude, longitude, accuracy } = e.detail.position;

        /* ① 하단 바 텍스트 (accuracy 값이 없으면 N/A) */
        const accText =
          Number.isFinite(accuracy) && accuracy > 0
            ? `±${Math.round(accuracy)} m`
            : '정확도 N/A';

        bar.textContent =
          `📍 ${latitude.toFixed(5)}, ${longitude.toFixed(5)}  ${accText}`;

        /* ② 목표와의 거리―30 m 미만이면 박스 표시 */
        const d = distanceM({ lat: latitude, lon: longitude }, TARGET);
        box.setAttribute('visible', d < 30000);
      });
    });
  </script>
</body>
</html>
